<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SurvValPlots Vignette â€¢ SurvValPlots</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SurvValPlots Vignette">
<meta property="og:description" content="SurvValPlots">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SurvValPlots</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/SurvValPlots_vignette.html">SurvValPlots Vignette</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SurvValPlots Vignette</h1>
            
      
      
      <div class="hidden name"><code>SurvValPlots_vignette.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>There are three main areas of clinical prediction model performance:
discrimination, calibration, and net benefit. These can be assessed
using receiver operating characteristic (ROC) curves, calibration
curves, and decision curves. For ROC and calibration curves, it is
important to also view confidence intervals or bands. Survival models
often have censored data which makes ROC and calibration curves more
difficult.</p>
<p>Previous packages either allow for right-censoring or give confidence
intervals; however, there is not yet an easy method for both. This
package was created to build upon previous methods and to fill the gap
in current tools.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SurvValPlots</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-data">Example data<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h2>
<p>We will use two data sets from the survival (Therneau 2023) package
to demonstrate the functions in survPlots</p>
<ul>
<li><p>Rotterdam - 2,982 participants with breast cancer in the
Rotterdam tumour bank (Royston and Altman 2013).</p></li>
<li><p>GBSG - 686 patients from the German Breast Cancer Study Group
(Royston and Altman 2013).</p></li>
</ul>
<p>A simple model will be developed using the Rotterdam data and the
GBSG data will be used for external validation.</p>
</div>
<div class="section level2">
<h2 id="sample-size">Sample size<a class="anchor" aria-label="anchor" href="#sample-size"></a>
</h2>
<p>The function <code>calcSS</code> calculates the minimum required
sample size for the survival model development. It is a wrapper for
<code><a href="https://rdrr.io/pkg/pmsampsize/man/pmsampsize.html" class="external-link">pmsampsize::pmsampsize</a></code> (Ensor, Martin, and Riley 2022) with
the added functionality of the <span class="math inline">\(R^2\)</span>
value being estimated from the event rate (Riley, Van Calster, and
Collins 2020) and allowing an imprecision in the event rate and mean
follow-up time to be specified.</p>
<p>Below is an example with an event rate of 10% at the prediction time
of 3 years with 5 parameters used in the model and a mean follow-up time
of 10 years. We allow for an imprecision of 20% in the rate and mean
follow-up time. This gives a minimum sample size of 331
participants.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calcSS.html">calcSS</a></span><span class="op">(</span></span>
<span>  rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span>  time<span class="op">=</span><span class="fl">3</span>,</span>
<span>  parameters<span class="op">=</span><span class="fl">5</span>,</span>
<span>  meanfollowup <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  imprecision <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NB: Assuming 0.05 acceptable difference in apparent &amp; adjusted R-squared </span></span>
<span><span class="co">## NB: Assuming 0.05 margin of error in estimation of overall risk at time point = 3  </span></span>
<span><span class="co">## NB: Events per Predictor Parameter (EPP) assumes overall event rate = 0.08  </span></span>
<span><span class="co">##  </span></span>
<span><span class="co">##              Samp_size Shrinkage Parameter    CS_Rsq Max_Rsq Nag_Rsq   EPP</span></span>
<span><span class="co">## Criteria 1         331      0.90         5 0.1264438   0.843    0.15 42.37</span></span>
<span><span class="co">## Criteria 2         109      0.75         5 0.1264438   0.843    0.15 13.95</span></span>
<span><span class="co">## Criteria 3 *       331      0.90         5 0.1264438   0.843    0.15 42.37</span></span>
<span><span class="co">## Final SS           331      0.90         5 0.1264438   0.843    0.15 42.37</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">##  Minimum sample size required for new model development based on user inputs = 331, </span></span>
<span><span class="co">##  corresponding to 2648 person-time** of follow-up, with 212 outcome events </span></span>
<span><span class="co">##  assuming an overall event rate = 0.08 and therefore an EPP = 42.37  </span></span>
<span><span class="co">##  </span></span>
<span><span class="co">##  * 95% CI for overall risk = (0.188, 0.238), for true value of 0.213 and sample size n = 331 </span></span>
<span><span class="co">##  **where time is in the units mean follow-up time was specified in</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="model">Model<a class="anchor" aria-label="anchor" href="#model"></a>
</h2>
<p>To demonstrate the package, we will develop a Cox proportional
hazards model using <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">survival::coxph</a></code>. This is the same model
as used by Royston and Altman (Royston and Altman 2013).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">rtime</span>, <span class="va">recur</span><span class="op">)</span><span class="op">~</span><span class="va">size</span><span class="op">+</span><span class="va">meno</span><span class="op">+</span><span class="va">hormon</span><span class="op">+</span><span class="va">age</span><span class="op">+</span><span class="va">nodes</span><span class="op">+</span><span class="va">pgr</span><span class="op">+</span><span class="va">er</span>, </span>
<span>            data<span class="op">=</span><span class="va">rotterdam</span>,</span>
<span>            x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="roc-curves">ROC curves<a class="anchor" aria-label="anchor" href="#roc-curves"></a>
</h2>
<p>ROC curves are one of the most reported visualisations of model
performance.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/survPlots.html">survPlots</a></span><span class="op">(</span><span class="va">mod</span>, </span>
<span>          time<span class="op">=</span><span class="fl">365.25</span><span class="op">*</span><span class="fl">3</span>, </span>
<span>          df<span class="op">=</span><span class="va">rotterdam</span>,</span>
<span>          eventVar <span class="op">=</span> <span class="st">"recur"</span>,</span>
<span>          timeVar <span class="op">=</span> <span class="st">"rtime"</span>,</span>
<span>          plotType <span class="op">=</span> <span class="st">"ROC"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Setting levels: control = 0, case = 1</span></span></code></pre>
<pre><code><span><span class="co">## Setting direction: controls &lt; cases</span></span></code></pre>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">x</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span></span></code></pre>
<p><img src="SurvValPlots_vignette_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="calibration-curves">Calibration curves<a class="anchor" aria-label="anchor" href="#calibration-curves"></a>
</h2>
<p>Calibration curves are a vital, but overlooked performance metric
(Van Calster et al.Â 2019). There are several packages already available
in R for constructing calibration curves (Harrell Jr 2023; Sadatsafavi,
Safari, and Lee 2023; Van Calster et al.Â 2016; Gerds 2023). The
calibration curve in <code>pec</code> accounts for the right censored
data using the jackknife pseudo-values (Gerds 2023); however, no
confidence interval or band is displayed. Confidence intervals and bands
can be useful to show potential variation in the calibration. The
calibration curve in <code>CalibrationCurves</code> does have confidence
bands, but does not account for censoring.</p>
<p>The calibration curve in <code>SurvValPlots</code> uses the jackknife
pseudo-values to account for right-censoring and also uses loess
smoothing with 95% confidence bands.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/survPlots.html">survPlots</a></span><span class="op">(</span><span class="va">mod</span>, </span>
<span>          time<span class="op">=</span><span class="fl">365.25</span><span class="op">*</span><span class="fl">3</span>, </span>
<span>          df<span class="op">=</span><span class="va">rotterdam</span>,</span>
<span>          eventVar <span class="op">=</span> <span class="st">"recur"</span>,</span>
<span>          timeVar <span class="op">=</span> <span class="st">"rtime"</span>,</span>
<span>          plotType <span class="op">=</span> <span class="st">"Calibration"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `geom_smooth()` using formula = 'y ~ x'</span></span></code></pre>
<p><img src="SurvValPlots_vignette_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="decision-curves">Decision curves<a class="anchor" aria-label="anchor" href="#decision-curves"></a>
</h2>
<p>The net benefit of a model can be define as</p>
<p><span class="math display">\[
NB = \frac{TP}{n}-\frac{FP}{n}\left(\frac{p}{1-p}\right)-H,
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(TP\)</span> is the number of true
positives</li>
<li>
<span class="math inline">\(FP\)</span> is the number of false
negatives</li>
<li>
<span class="math inline">\(n\)</span> is the total number of
observations</li>
<li>
<span class="math inline">\(p\)</span> is the chosen probability
threshold</li>
<li>
<span class="math inline">\(H\)</span> is the harm of the model</li>
</ul>
<p>The harm of a model can be estimated in terms of how many patients
the clinician is willing to put through the test to catch one positive
case (<span class="math inline">\(N_p\)</span>), with the harm being
<span class="math inline">\(H=1/N_p\)</span>.</p>
<p>The net benefit can then be plotted across a range of clinically
relevant probability thresholds. The net benefit of treating all or no
patients as having the disease or condition can also be plotted for
reference.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/survPlots.html">survPlots</a></span><span class="op">(</span><span class="va">mod</span>, </span>
<span>          time<span class="op">=</span><span class="fl">365.25</span><span class="op">*</span><span class="fl">3</span>, </span>
<span>          df<span class="op">=</span><span class="va">rotterdam</span>,</span>
<span>          eventVar <span class="op">=</span> <span class="st">"recur"</span>,</span>
<span>          timeVar <span class="op">=</span> <span class="st">"rtime"</span>,</span>
<span>          plotType <span class="op">=</span> <span class="st">"Decision"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 1 row containing missing values (`geom_line()`).</span></span>
<span><span class="co">## Removed 1 row containing missing values (`geom_line()`).</span></span></code></pre>
<p><img src="SurvValPlots_vignette_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="all">All<a class="anchor" aria-label="anchor" href="#all"></a>
</h2>
<p>Setting the option <code>plotType="All"</code> plots all three of the
graphs into one panel. This allows an easy visualisation of overall
discrimination, calibration, and net benefit at a chosen time point with
a single, short command.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/survPlots.html">survPlots</a></span><span class="op">(</span><span class="va">mod</span>, </span>
<span>          time<span class="op">=</span><span class="fl">365.25</span><span class="op">*</span><span class="fl">3</span>, </span>
<span>          df<span class="op">=</span><span class="va">rotterdam</span>,</span>
<span>          eventVar <span class="op">=</span> <span class="st">"recur"</span>,</span>
<span>          timeVar <span class="op">=</span> <span class="st">"rtime"</span>,</span>
<span>          plotType <span class="op">=</span> <span class="st">"All"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Setting levels: control = 0, case = 1</span></span></code></pre>
<pre><code><span><span class="co">## Setting direction: controls &lt; cases</span></span></code></pre>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">x</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span></span>
<span><span class="co">## `geom_smooth()` using formula = 'y ~ x'</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Removed 1 row containing missing values (`geom_line()`).</span></span>
<span><span class="co">## Removed 1 row containing missing values (`geom_line()`).</span></span></code></pre>
<p><img src="SurvValPlots_vignette_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Joshua Bridge.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
